name: Run Chat Server with ngrok

on:
  workflow_dispatch: # รันได้ด้วยตนเอง

jobs:
  run-server:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '24'

    - name: Install dependencies
      run: npm install

    - name: Download ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath ngrok

    - name: Authenticate ngrok
      run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Run Node.js server
      run: |
        start /B cmd /c "node server.js"

    - name: Start ngrok HTTP tunnel
      run: |
        start /B cmd /c ".\ngrok\ngrok.exe http 3000 --log=stdout > ngrok.log"

    - name: Show ngrok URL
      run: |
        timeout /t 5
        $url = Select-String -Path ngrok.log -Pattern "url=https://.*\.ngrok.io" | ForEach-Object { $_.Matches[0].Value.Split('=')[1] }
        Write-Host "Ngrok URL: $url"
